---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Inventario">
  <div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
        <h2 class="text-3xl font-bold text-gray-800">Inventario de Productos</h2>
        <div class="flex flex-col sm:flex-row gap-3">
          <div class="flex gap-2">
            <input 
              type="number" 
              id="tasa-dolar" 
              placeholder="Tasa Dólar (Bs)" 
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <button 
              id="btn-actualizar-tasa"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
            >
              Actualizar Tasa
            </button>
          </div>
          <button 
            id="btn-nuevo-producto"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
          >
            + Nuevo Producto
          </button>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Código</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Producto</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cantidad</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Precio USD</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Precio Bs</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-productos" class="bg-white divide-y divide-gray-200">
            <!-- Los productos se cargarán aquí -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Nuevo Producto -->
  <div id="modal-nuevo" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold mb-4">Nuevo Producto</h3>
      <form id="form-nuevo-producto" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Código</label>
          <input type="text" name="codigo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
          <input type="text" name="nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
          <input type="number" name="cantidad" required min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Precio USD</label>
          <input type="number" name="precio_usd" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Guardar</button>
          <button type="button" id="btn-cerrar-modal-nuevo" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Actualizar Proveedor -->
  <div id="modal-proveedor" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold mb-4">Actualizar desde Proveedor</h3>
      <form id="form-proveedor" class="space-y-4">
        <input type="hidden" name="producto_id" />
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Producto</label>
          <input type="text" name="producto_nombre" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad a Agregar</label>
          <input type="number" name="cantidad" required min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nuevo Precio USD (si subió)</label>
          <input type="number" name="precio_usd" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Actualizar</button>
          <button type="button" id="btn-cerrar-modal-proveedor" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script is:inline>
    let productos = [];
    let tasaDolar = 1;

    async function cargarTasaDolar() {
      try {
        const res = await fetch('/api/tasa-dolar');
        const data = await res.json();
        if (data.success) {
          tasaDolar = data.tasa;
          document.getElementById('tasa-dolar').value = tasaDolar;
        }
      } catch (error) {
        console.error('Error cargando tasa:', error);
      }
    }

    async function actualizarTasaDolar() {
      const tasa = parseFloat(document.getElementById('tasa-dolar').value);
      if (!tasa || tasa <= 0) {
        alert('Ingrese una tasa válida');
        return;
      }

      try {
        const res = await fetch('/api/tasa-dolar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tasa })
        });
        const data = await res.json();
        if (data.success) {
          tasaDolar = data.tasa;
          alert('Tasa actualizada. Todos los precios han sido recalculados.');
          cargarProductos();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error al actualizar tasa');
        console.error(error);
      }
    }

    async function cargarProductos() {
      try {
        const res = await fetch('/api/productos');
        const data = await res.json();
        if (data.success) {
          productos = data.data;
          renderizarProductos();
        }
      } catch (error) {
        console.error('Error cargando productos:', error);
      }
    }

    function renderizarProductos() {
      const tbody = document.getElementById('tabla-productos');
      if (productos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No hay productos registrados</td></tr>';
        return;
      }

      tbody.innerHTML = productos.map(p => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${p.codigo}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${p.nombre}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${p.cantidad}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">$${parseFloat(p.precio_usd).toFixed(2)}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${parseFloat(p.precio_bs).toFixed(2)} Bs</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm">
            <button data-producto-id="${p.id}" class="btn-actualizar-proveedor px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
              Actualizar
            </button>
          </td>
        </tr>
      `).join('');
      
      // Agregar event listeners a los botones de actualizar
      document.querySelectorAll('.btn-actualizar-proveedor').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.getAttribute('data-producto-id'));
          abrirModalProveedor(id);
        });
      });
    }

    function abrirModalNuevo() {
      document.getElementById('modal-nuevo').classList.remove('hidden');
      document.getElementById('form-nuevo-producto').reset();
    }

    function cerrarModalNuevo() {
      document.getElementById('modal-nuevo').classList.add('hidden');
    }

    function abrirModalProveedor(id) {
      const producto = productos.find(p => p.id === id);
      if (!producto) return;
      
      document.getElementById('form-proveedor').producto_id.value = producto.id;
      document.getElementById('form-proveedor').producto_nombre.value = producto.nombre;
      document.getElementById('form-proveedor').precio_usd.value = producto.precio_usd;
      document.getElementById('modal-proveedor').classList.remove('hidden');
    }

    function cerrarModalProveedor() {
      document.getElementById('modal-proveedor').classList.add('hidden');
    }

    document.getElementById('form-nuevo-producto').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {
        codigo: formData.get('codigo'),
        nombre: formData.get('nombre'),
        cantidad: parseInt(formData.get('cantidad')),
        precio_usd: parseFloat(formData.get('precio_usd'))
      };

      try {
        const res = await fetch('/api/productos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          cerrarModalNuevo();
          cargarProductos();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error al crear producto');
        console.error(error);
      }
    });

    document.getElementById('form-proveedor').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {
        id: parseInt(formData.get('producto_id')),
        cantidad: parseInt(formData.get('cantidad')),
        precio_usd: parseFloat(formData.get('precio_usd'))
      };

      try {
        const res = await fetch('/api/productos', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          cerrarModalProveedor();
          cargarProductos();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error al actualizar producto');
        console.error(error);
      }
    });

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializar);
    } else {
      inicializar();
    }
    
    function inicializar() {
      // Event listeners
      document.getElementById('btn-nuevo-producto').addEventListener('click', abrirModalNuevo);
      document.getElementById('btn-actualizar-tasa').addEventListener('click', actualizarTasaDolar);
      document.getElementById('btn-cerrar-modal-nuevo').addEventListener('click', cerrarModalNuevo);
      document.getElementById('btn-cerrar-modal-proveedor').addEventListener('click', cerrarModalProveedor);
      
      // Cerrar modal al hacer click fuera
      document.getElementById('modal-nuevo').addEventListener('click', (e) => {
        if (e.target.id === 'modal-nuevo') {
          cerrarModalNuevo();
        }
      });
      
      document.getElementById('modal-proveedor').addEventListener('click', (e) => {
        if (e.target.id === 'modal-proveedor') {
          cerrarModalProveedor();
        }
      });

      // Cargar datos
      cargarTasaDolar();
      cargarProductos();
    }
  </script>
</Layout>

