---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Factura">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Nueva Factura</h2>
    
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="text-xl font-semibold mb-4">Datos del Cliente</h3>
      <form id="form-cliente" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Cédula *</label>
          <input type="text" id="cliente-cedula" name="cedula" required placeholder="V-12345678" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
          <p id="cliente-status" class="text-xs text-gray-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
          <input type="text" name="nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
          <input type="text" name="direccion" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
          <input type="text" name="telefono" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
      </form>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="text-xl font-semibold mb-4">Agregar Productos</h3>
      <div class="flex flex-col sm:flex-row gap-3 mb-4">
        <select id="select-producto" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">Seleccione un producto</option>
        </select>
        <input 
          type="number" 
          id="cantidad-producto" 
          placeholder="Cantidad" 
          min="1" 
          class="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        />
        <button 
          id="btn-agregar-producto"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
          Agregar
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Cantidad</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Producto</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Precio Unit. USD</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Precio Unit. Bs</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Subtotal Bs</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Acción</th>
            </tr>
          </thead>
          <tbody id="tabla-items" class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="6" class="px-4 py-8 text-center text-gray-500">No hay productos agregados</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-6 flex justify-end">
        <div class="text-right">
          <div class="text-2xl font-bold text-gray-800">
            Total: <span id="total-bs">0.00</span> Bs
          </div>
          <div class="text-lg text-gray-600">
            (<span id="total-usd">0.00</span> USD)
          </div>
        </div>
      </div>
    </div>

    <div class="flex gap-4 justify-end">
      <button 
        id="btn-limpiar-factura"
        class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
      >
        Limpiar
      </button>
      <button 
        id="btn-procesar-factura"
        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
      >
        Procesar Factura
      </button>
    </div>
  </div>

  <script is:inline>
    let productos = [];
    let itemsFactura = [];
    let clienteEncontrado = null;

    async function cargarProductos() {
      try {
        const res = await fetch('/api/productos');
        const data = await res.json();
        if (data.success) {
          productos = data.data;
          const select = document.getElementById('select-producto');
          select.innerHTML = '<option value="">Seleccione un producto</option>' +
            productos.map(p => 
              `<option value="${p.id}" data-precio-usd="${p.precio_usd}" data-precio-bs="${p.precio_bs}" data-stock="${p.cantidad}">
                ${p.codigo} - ${p.nombre} (Stock: ${p.cantidad})
              </option>`
            ).join('');
        }
      } catch (error) {
        console.error('Error cargando productos:', error);
      }
    }

    function agregarProducto() {
      const select = document.getElementById('select-producto');
      const cantidadInput = document.getElementById('cantidad-producto');
      const productoId = parseInt(select.value);
      const cantidad = parseInt(cantidadInput.value);

      if (!productoId || !cantidad || cantidad <= 0) {
        alert('Seleccione un producto y una cantidad válida');
        return;
      }

      const option = select.options[select.selectedIndex];
      const stock = parseInt(option.dataset.stock);
      const precioUsd = parseFloat(option.dataset.precioUsd);
      const precioBs = parseFloat(option.dataset.precioBs);

      // Verificar stock disponible
      const cantidadYaAgregada = itemsFactura
        .filter(item => item.producto_id === productoId)
        .reduce((sum, item) => sum + item.cantidad, 0);

      if (cantidadYaAgregada + cantidad > stock) {
        alert(`Stock insuficiente. Disponible: ${stock - cantidadYaAgregada}`);
        return;
      }

      // Verificar si el producto ya está en la factura
      const itemExistente = itemsFactura.find(item => item.producto_id === productoId);
      if (itemExistente) {
        itemExistente.cantidad += cantidad;
      } else {
        const producto = productos.find(p => p.id === productoId);
        itemsFactura.push({
          producto_id: productoId,
          producto_codigo: producto.codigo,
          producto_nombre: producto.nombre,
          cantidad: cantidad,
          precio_usd: precioUsd,
          precio_bs: precioBs
        });
      }

      cantidadInput.value = '';
      select.value = '';
      renderizarItems();
    }

    function eliminarItem(index) {
      itemsFactura.splice(index, 1);
      renderizarItems();
    }

    function renderizarItems() {
      const tbody = document.getElementById('tabla-items');
      
      if (itemsFactura.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No hay productos agregados</td></tr>';
        document.getElementById('total-bs').textContent = '0.00';
        document.getElementById('total-usd').textContent = '0.00';
        return;
      }

      let totalBs = 0;
      let totalUsd = 0;

      tbody.innerHTML = itemsFactura.map((item, index) => {
        const subtotalBs = item.cantidad * item.precio_bs;
        const subtotalUsd = item.cantidad * item.precio_usd;
        totalBs += subtotalBs;
        totalUsd += subtotalUsd;

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 whitespace-nowrap text-sm">${item.cantidad}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">${item.producto_nombre}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">$${item.precio_usd.toFixed(2)}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">${item.precio_bs.toFixed(2)} Bs</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">${subtotalBs.toFixed(2)} Bs</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">
              <button data-item-index="${index}" class="btn-eliminar-item px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">
                Eliminar
              </button>
            </td>
          </tr>
        `;
      }).join('');

      document.getElementById('total-bs').textContent = totalBs.toFixed(2);
      document.getElementById('total-usd').textContent = totalUsd.toFixed(2);
      
      // Agregar event listeners a los botones de eliminar
      document.querySelectorAll('.btn-eliminar-item').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.getAttribute('data-item-index'));
          eliminarItem(index);
        });
      });
    }

    function setEstadoCliente(mensaje = '', tipo = 'info') {
      const status = document.getElementById('cliente-status');
      if (!status) return;
      const color = tipo === 'success' ? 'text-green-600' : tipo === 'error' ? 'text-red-600' : 'text-gray-500';
      status.className = `text-xs mt-1 ${color}`;
      status.textContent = mensaje;
    }

    function limpiarFactura() {
      if (confirm('¿Está seguro de limpiar la factura?')) {
        itemsFactura = [];
        document.getElementById('form-cliente').reset();
        clienteEncontrado = null;
        setEstadoCliente('');
        renderizarItems();
      }
    }

    async function procesarFactura() {
      const formData = new FormData(document.getElementById('form-cliente'));
      const cliente = {
        cedula: (formData.get('cedula') || '').trim(),
        nombre: formData.get('nombre'),
        direccion: formData.get('direccion') || '',
        telefono: formData.get('telefono') || ''
      };

      if (!cliente.cedula) {
        alert('Ingrese la cédula del cliente');
        return;
      }

      if (!cliente.nombre) {
        alert('Ingrese el nombre del cliente');
        return;
      }

      if (itemsFactura.length === 0) {
        alert('Agregue al menos un producto');
        return;
      }

      try {
        const res = await fetch('/api/ventas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cliente, items: itemsFactura })
        });
        const data = await res.json();
        if (data.success) {
          alert('Factura procesada exitosamente');
          limpiarFactura();
          cargarProductos(); // Recargar para actualizar stock
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error al procesar factura');
        console.error(error);
      }
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializar);
    } else {
      inicializar();
    }
    
    function inicializar() {
      // Event listeners
      document.getElementById('btn-agregar-producto').addEventListener('click', agregarProducto);
      document.getElementById('btn-limpiar-factura').addEventListener('click', limpiarFactura);
      document.getElementById('btn-procesar-factura').addEventListener('click', procesarFactura);
      
      // Permitir agregar producto con Enter en el campo de cantidad
      document.getElementById('cantidad-producto').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          agregarProducto();
        }
      });
      
      // Cargar productos
      cargarProductos();
      const cedulaInput = document.getElementById('cliente-cedula');
      const nombreInput = document.querySelector('#form-cliente [name="nombre"]');
      const direccionInput = document.querySelector('#form-cliente [name="direccion"]');
      const telefonoInput = document.querySelector('#form-cliente [name="telefono"]');

      async function buscarClientePorCedula() {
        const cedula = cedulaInput.value.trim();
        if (!cedula) {
          clienteEncontrado = null;
          nombreInput.value = '';
          direccionInput.value = '';
          telefonoInput.value = '';
          setEstadoCliente('Ingrese la cédula para buscar al cliente', 'info');
          return;
        }

        setEstadoCliente('Buscando cliente...', 'info');
        try {
          const res = await fetch(`/api/clientes?cedula=${encodeURIComponent(cedula)}`);
          const data = await res.json();
          if (data.success && data.data) {
            clienteEncontrado = data.data;
            nombreInput.value = data.data.nombre || '';
            direccionInput.value = data.data.direccion || '';
            telefonoInput.value = data.data.telefono || '';
            setEstadoCliente('Cliente encontrado y cargado automáticamente.', 'success');
          } else {
            clienteEncontrado = null;
            setEstadoCliente('Cliente nuevo. Se registrará al procesar la factura.', 'info');
          }
        } catch (error) {
          console.error('Error buscando cliente:', error);
          setEstadoCliente('No se pudo buscar al cliente. Intente nuevamente.', 'error');
        }
      }

      cedulaInput.addEventListener('change', buscarClientePorCedula);
      cedulaInput.addEventListener('blur', buscarClientePorCedula);
      cedulaInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          buscarClientePorCedula();
        }
      });

      // Mensaje inicial
      setEstadoCliente('Ingrese la cédula para buscar al cliente.', 'info');
    }
  </script>
</Layout>

